---
tags: 
   - bug排查
---

生产环境的某个kafka消费者集群在业务高峰期大概率性能出现断崖式下跌,每次持续大概1分钟以后恢复正常.

将部分生产流量导入灰度环境,尝试重现问题,然而失败.看了很久代码,也没找到问题.最后经过运维提醒才发现原来每次业务高峰期都会触发k8s伸缩. 导致kafka rebalance,降低消息的消费速度.

<!--more-->

## k8s伸缩的工作原理


k8s会监控一个pod的cpu使用率和内存占用率,如果在一个周期内占用率达到设定的阈值,就会创建新的实例以减轻它的压力.反之如果一段时间内负载较低,那么就会关闭pod下的部分实例从而释放资源.
{:.success}

那么什么时候会发生 rebalance 呢？

## 触发rebalance的原因

以下三种情况,会触发kafka的rebalance:

- 订阅 Topic 的分区数发生变化
- 订阅的 Topic 个数发生变化
- 消费组内成员个数发生变化。例如有新的 consumer 实例加入该消费组或者离开组

我们碰到的情况属于第三种.新增实例导致新增消费者.

## 解决方法

通过增加消费者集群的默认实例数量,并提高扩容阈值.从而避免在业务高峰期触发rebalance